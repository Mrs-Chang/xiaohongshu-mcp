# 小红书 MCP 项目技术总结

## 项目概述

这是一个基于 **MCP (Model Context Protocol)** 协议的小红书自动化操作项目，通过浏览器自动化技术实现小红书内容的发布、搜索、获取和评论等功能。项目采用 Go 语言开发，提供 HTTP API 和 MCP 协议两种访问方式。

## 核心技术栈

### 1. 编程语言与框架
- **Go 1.23.5**: 主要开发语言
- **Gin**: Web 框架，用于构建 HTTP API 服务
- **go-rod**: 浏览器自动化库，基于 Chrome DevTools Protocol

### 2. 浏览器自动化技术
- **Chrome DevTools Protocol (CDP)**: 底层浏览器控制协议
- **Headless Browser**: 支持有头/无头模式运行
- **页面元素操作**: CSS 选择器、DOM 操作、JavaScript 执行
- **等待机制**: DOM 稳定性检测、元素可见性等待

### 3. MCP 协议支持
- **JSON-RPC 2.0**: 基于 JSON-RPC 的通信协议
- **Streamable HTTP**: 支持 SSE (Server-Sent Events) 的流式响应
- **工具系统**: 定义了 6 个核心工具函数

### 4. 依赖管理
```go
// 核心依赖包
github.com/gin-gonic/gin v1.10.1          // Web 框架
github.com/go-rod/rod v0.116.2            // 浏览器自动化
github.com/sirupsen/logrus v1.9.3         // 日志系统
github.com/pkg/errors v0.9.1              // 错误处理
github.com/h2non/filetype v1.1.3          // 文件类型检测
github.com/xpzouying/headless_browser v0.0.2 // 自定义浏览器配置
```

## 架构设计

### 1. 项目结构
```
xiaohongshu-mcp/
├── main.go                 # 程序入口
├── app_server.go           # 应用服务器
├── routes.go               # 路由配置
├── handlers_api.go         # HTTP API 处理器
├── mcp_handlers.go         # MCP 工具处理器
├── streamable_http.go      # MCP 协议实现
├── service.go              # 业务逻辑服务层
├── types.go                # 数据结构定义
├── middleware.go           # 中间件
├── xiaohongshu/           # 小红书操作模块
│   ├── login.go           # 登录功能
│   ├── publish.go         # 内容发布
│   ├── search.go          # 搜索功能
│   ├── feeds.go           # Feed 列表
│   ├── feed_detail.go     # 详情获取
│   ├── comment_feed.go    # 评论功能
│   └── types.go           # 数据结构
├── browser/               # 浏览器配置
├── configs/               # 配置管理
├── cookies/               # Cookie 管理
└── pkg/                   # 工具包
    └── downloader/        # 图片下载器
```

### 2. 服务架构
```
Client (AI Assistant/API Consumer)
         ↓
HTTP Server (Gin) / MCP Protocol
         ↓
Business Service Layer
         ↓
Xiaohongshu Module (Browser Automation)
         ↓
Chrome Browser → 小红书网站
```

## 核心功能模块

### 1. 浏览器自动化模块 (`xiaohongshu/`)

#### **登录管理** (`login.go`)
- 自动检测登录状态
- 二维码扫码登录支持
- Cookie 持久化

#### **内容发布** (`publish.go`)
- 图文内容发布
- 多图片上传支持
- 富文本编辑器操作
- 动态元素查找策略

#### **搜索功能** (`search.go`)
- 关键词搜索
- 结果数据提取
- 分页支持

#### **Feed 操作** (`feeds.go`, `feed_detail.go`)
- 首页 Feed 列表获取
- 详情页数据提取
- 评论列表获取

#### **评论功能** (`comment_feed.go`)
- 自动评论发表
- 评论内容输入

### 2. 数据获取策略

#### **JavaScript 数据提取**
```go
// 获取页面初始状态数据
result := page.MustEval(`() => {
    if (window.__INITIAL_STATE__) {
        return JSON.stringify(window.__INITIAL_STATE__);
    }
    return "";
}`).String()
```

#### **页面元素定位**
- CSS 选择器: `.upload-input`, `div.creator-tab`
- 属性选择器: `[data-placeholder*="输入正文描述"]`
- 文本内容匹配: 通过元素文本定位
- 父子元素遍历: 向上查找特定属性的父元素

### 3. MCP 协议实现

#### **支持的工具列表**
1. `check_login_status` - 检查登录状态
2. `publish_content` - 发布图文内容
3. `list_feeds` - 获取 Feed 列表
4. `search_feeds` - 搜索内容
5. `get_feed_detail` - 获取详情
6. `post_comment_to_feed` - 发表评论

#### **协议特性**
- JSON-RPC 2.0 标准
- 支持 SSE 流式响应
- CORS 跨域支持
- 错误处理机制

### 4. HTTP API 设计

#### **RESTful 接口**
```
GET  /health                    # 健康检查
GET  /api/v1/login/status      # 检查登录状态
POST /api/v1/publish           # 发布内容
GET  /api/v1/feeds/list        # 获取 Feed 列表
GET  /api/v1/feeds/search      # 搜索 Feed
POST /api/v1/feeds/detail      # 获取 Feed 详情
POST /api/v1/feeds/comment     # 发表评论
```

#### **统一响应格式**
```go
// 成功响应
type SuccessResponse struct {
    Success bool   `json:"success"`
    Data    any    `json:"data"`
    Message string `json:"message"`
}

// 错误响应
type ErrorResponse struct {
    Error   string `json:"error"`
    Code    string `json:"code"`
    Details any    `json:"details"`
}
```

## 技术亮点

### 1. 浏览器自动化技术
- **真实浏览器环境**: 使用 Chrome 浏览器，难以被反爬虫检测
- **动态内容支持**: 可处理 JavaScript 渲染的页面
- **复杂交互**: 支持文件上传、富文本编辑等复杂操作
- **等待机制**: 智能等待页面加载和元素出现

### 2. 数据提取策略
- **多策略元素定位**: CSS选择器 + 属性查找 + 文本匹配
- **JavaScript 执行**: 直接获取页面 `window.__INITIAL_STATE__` 数据
- **容错机制**: Race 方法处理多种可能的页面结构

### 3. MCP 协议集成
- **标准协议**: 完全符合 MCP 2025-03-26 协议规范
- **工具系统**: 提供完整的小红书操作工具集
- **流式支持**: 支持 SSE 实时响应（可扩展）

### 4. 架构设计
- **分层架构**: 清晰的业务逻辑分层
- **模块化**: 功能模块独立，易于维护
- **双协议支持**: 同时支持 HTTP API 和 MCP 协议

## 技术挑战与解决方案

### 1. 页面结构变化
**挑战**: 小红书页面结构可能随时变化
**解决方案**: 
- 多策略元素查找
- Race 方法处理不同页面版本
- 容错机制和日志记录

### 2. 反爬虫检测
**挑战**: 网站可能检测自动化行为
**解决方案**:
- 使用真实浏览器环境
- 模拟人类操作时间间隔
- Cookie 持久化维持登录状态

### 3. 异步内容加载
**挑战**: 页面内容动态加载
**解决方案**:
- 等待 DOM 稳定
- JavaScript 执行检测
- 元素可见性等待

### 4. 复杂表单操作
**挑战**: 富文本编辑器等复杂组件
**解决方案**:
- 多种输入方式尝试
- 属性和角色检测
- 父子元素遍历查找

## 部署与运行

### 1. 环境要求
- Go 1.23.5+
- Chrome/Chromium 浏览器
- Linux/macOS/Windows

### 2. 配置选项
- 有头/无头模式切换
- 端口配置 (默认: 18060)
- 浏览器参数配置

### 3. 启动方式
```bash
# 无头模式（默认）
./xiaohongshu-mcp

# 有头模式（调试用）
./xiaohongshu-mcp -headless=false
```

## 扩展性

### 1. 新功能添加
- 在 `xiaohongshu/` 目录添加新的操作模块
- 在 `mcp_handlers.go` 添加对应的 MCP 工具
- 在 `handlers_api.go` 添加 HTTP API 端点

### 2. 协议扩展
- 支持 WebSocket 连接
- 添加实时通知功能
- 扩展流式响应支持

### 3. 数据处理
- 图片处理和优化
- 内容格式转换
- 数据持久化存储

## 总结

这个项目成功地将现代浏览器自动化技术与 MCP 协议结合，提供了一个完整的小红书操作解决方案。通过 go-rod 实现的浏览器自动化确保了操作的真实性和可靠性，而 MCP 协议的支持使得项目可以轻松集成到各种 AI 助手中。

项目的技术架构清晰，模块化设计良好，具有很好的可维护性和扩展性。通过多种技术手段解决了网页自动化中的常见挑战，是一个技术实现较为完善的自动化项目。
